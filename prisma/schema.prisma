generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String
  nameEn            String?
  phone             String?
  avatar            String?
  defaultMode       String    @default("buyer")
  status            String    @default("active")
  emailVerified     Boolean   @default(false)
  createdAt         DateTime  @default(now())
  lastLogin         DateTime?
  
  buyerProfile      BuyerProfile?
  providerProfile   ProviderProfile?
}

model BuyerProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  
  companyName     String
  companyNameEn   String?
  crNumber        String?
  industry        String?
  companySize     String?
  contactName     String
  contactRole     String?
  contactEmail    String
  contactPhone    String?
  city            String?
  country         String
  profileComplete Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projects        Project[]
  shortlist       ShortlistItem[]
}

model ProviderProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id])
  providerId            String?  // Link to Admin entity

  companyName           String
  companyNameEn         String?
  tagline               String?
  taglineEn             String?
  description           String?
  descriptionEn         String?
  logoUrl               String?
  coverUrl              String?
  crNumber              String?
  isSaudiVerified       Boolean  @default(false)
  foundedYear           Int?
  companySize           String
  contactName           String
  contactRole           String?
  contactEmail          String
  contactPhone          String?
  website               String?
  headquartersCity      String
  headquartersCountry   String
  serviceLocations      String[]
  linkedinUrl           String?
  twitterUrl            String?
  
  serviceLines          Json[]   // ServiceLine[]
  industries            Json[]   // IndustryFocus[]
  
  clients               ClientReference[]
  
  idealClientDescription String?
  minProjectSize         Int?
  maxProjectSize         Int?
  preferredProjectDuration String?
  certifications        String[]
  tags                  String[]
  keywords              String[]
  capabilities          String[]
  
  status                String   @default("draft")
  profileHealth         Int      @default(0)
  submittedForReviewAt  DateTime?
  reviewedAt            DateTime?
  reviewNotes           String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  projectResponses      ProjectResponse[]
  shortlistedBy         ShortlistItem[]
}

model ClientReference {
  id                  String          @id @default(uuid())
  providerProfileId   String
  providerProfile     ProviderProfile @relation(fields: [providerProfileId], references: [id])
  
  companyName         String
  projectDescription  String?
  projectType         String?
  year                Int?
  testimonial         String?
  isPublic            Boolean         @default(false)
  
  serviceCategoryId   Int?
  subserviceId        Int?
  industrySectorId    Int?
  subIndustryId       Int?
}

model Project {
  id                    String   @id @default(uuid())
  buyerProfileId        String
  buyerProfile          BuyerProfile @relation(fields: [buyerProfileId], references: [id])
  ownerUserId           String
  
  title                 String
  titleEn               String?
  category              String
  subcategory           String?
  description           String
  descriptionEn         String?
  deliverables          String[]
  goals                 String[]
  attachments           Json[]   // ProjectAttachment[]
  
  budgetBand            String
  budgetMin             Int?
  budgetMax             Int?
  timelineStart         DateTime?
  timelineEnd           DateTime?
  urgency               String
  
  preferredLocations    String[]
  remoteOk              Boolean  @default(true)
  saudiPresenceRequired Boolean  @default(false)
  
  status                String   @default("draft")
  invitedProviders      String[]
  excludedProviders     String[]
  
  responsesCount        Int      @default(0)
  meetingsCount         Int      @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  publishedAt           DateTime?
  closedAt              DateTime?

  responses             ProjectResponse[]
}

model ProjectResponse {
  id                  String          @id @default(uuid())
  projectId           String
  project             Project         @relation(fields: [projectId], references: [id])
  providerProfileId   String
  providerProfile     ProviderProfile @relation(fields: [providerProfileId], references: [id])
  
  status              String
  interestNote        String?
  declineReason       String?
  proposedBudget      Int?
  proposedTimeline    String?
  
  invitedAt           DateTime        @default(now())
  respondedAt         DateTime?
  updatedAt           DateTime        @updatedAt
}

model MessageThread {
  id              String   @id @default(uuid())
  projectId       String
  buyerUserId     String
  providerUserId  String
  
  lastMessage     String?
  lastMessageAt   DateTime?
  lastSenderType  String?
  buyerUnread     Int      @default(0)
  providerUnread  Int      @default(0)
  isArchived      Boolean  @default(false)
  isPriority      Boolean  @default(false)
  createdAt       DateTime @default(now())
}

model Message {
  id              String   @id @default(uuid())
  threadId        String
  senderId        String
  senderType      String
  content         String
  attachments     Json[]   // ProjectAttachment[]
  read            Boolean  @default(false)
  createdAt       DateTime @default(now())
}

model Meeting {
  id              String   @id @default(uuid())
  projectId       String
  threadId        String?
  buyerUserId     String
  providerUserId  String
  
  title           String
  description     String?
  proposedTimes   String[]
  scheduledAt     DateTime?
  durationMinutes Int      @default(30)
  meetingType     String
  meetingLink     String?
  meetingLocation String?
  status          String   @default("requested")
  buyerNotes      String?
  providerNotes   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ShortlistItem {
  id                String          @id @default(uuid())
  buyerProfileId    String
  buyerProfile      BuyerProfile    @relation(fields: [buyerProfileId], references: [id])
  providerProfileId String
  providerProfile   ProviderProfile @relation(fields: [providerProfileId], references: [id])
  notes             String?
  addedAt           DateTime        @default(now())
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        String
  title       String
  body        String
  link        String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Contact {
  id                    String   @id @default(uuid())
  first_name            String?
  last_name             String?
  name                 String
  email                String   @unique
  phone                String?
  title                String?
  company_name          String
  
  address1             String?
  city                 String?
  state                String?
  country              String?
  postal_code           String?
  timezone             String?
  website              String?

  // GHL Custom Fields
  initial_icebreaker     String?
  industry_2            String?
  function_2            String?
  company_official_name  String?
  title_description     String?
  linkedin_url          String?
  prospect_about        String?
  company_description   String?
  phone_2               String?
  size_2                String?
  source               String
  record_id             String?
  about                String?
  company_linkedin_url   String?
  linkedin_company_url   String?
  open_profile          String?
  premium              String?
  linkedin_sales_navigator String?
  date_of_birth          String?
  employee_count        String?
  company_country       String?
  arabic_summary        String?
  call_recordings       String?
  lowercase_business_name String?
  type                 String?
  welcome_message       String?
  follow_up_1            String?
  follow_up_2            String?
  follow_up_3            String?
  follow_up_4            String?
  subcategory          String?
  sub_subcategory       String?
  manufacture          String?
  annual_revenue        String?
  phone_updated         String?
  profile_unique_id      String?
  li_messages           String?
  company_location      String?
  third_scene           String?
  subject_f1            String?
  subject_f2            String?
  subject_f3            String?
  third_scene_subject    String?
  industry_tier         String?
  title_tier            String?
  final_icp_tier         String?
  industry_ar           String?
  field_ar              String?
  profile              String?
  b2b_status            String?
  industry_22           String?
  b2b_summary           String?

  // App Specific
  icp_status            String?
  fit_score             Int?
  stage                String?
  tags                 String[]
  
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  opportunities        Opportunity[]
}

model Business {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  email       String?
  website     String?
  address     String?
  state       String?
  city        String?
  description String?
  postal_code  String?
  country     String?
  
  opportunities Opportunity[]
}

model Opportunity {
  id                  String   @id @default(uuid())
  name                String
  pipeline_id          String
  pipeline_stage_id     String
  status              String
  monetary_value       Float?
  assigned_to          String?
  source              String?
  lost_reason          String?
  call_record_url       String?
  feedback            String?
  
  contact_id           String?
  contact             Contact? @relation(fields: [contact_id], references: [id])
  business_id          String?
  business            Business? @relation(fields: [business_id], references: [id])
  
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
}
